---
title: "Análisis IMDb con R"
author: "Christian Barrios"
date: "`r Sys.Date()`"
  md_document:
    variant: gfm
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
```

```{r Carga de Datos}
movies <- read.csv('movies.csv')
directors <- read.csv('directors.csv')
directors_genres <- read.csv('directors_genres.csv')
movies_directors <- read.csv('movies_directors.csv')
actors <- read.csv('actors.csv')
roles <- read.csv('roles.csv')
movies_genres <- read.csv('movies_genres.csv')
```

```{r Total de Películas y Directores}


total_movies <- movies %>% distinct(id) %>% nrow()
total_directors <- directors %>% distinct(id) %>% nrow()

resumen <- tibble(
  Total_Peliculas = total_movies,
  Total_Directores = total_directors,
)

print(resumen)

```

```{r Promedio de Géneros por Director}
avg_genres_per_director <- directors_genres %>%
  group_by(director_id) %>%
  summarise(total_genres = n()) %>%
  summarise(avg_genres = mean(total_genres))

avg_genres_per_director
```

```{r Reporte por Role}

peliculas_por_rol <- roles %>%
  group_by(role) %>%
  summarise(num_peliculas = n_distinct(movie_id))

actores_por_rol <- roles %>%
  left_join(actors, by = c("actor_id" = "id")) %>%
  filter(gender == 'M') %>%  
  group_by(role) %>%
  summarise(num_actores = n_distinct(actor_id))

actrices_por_rol <- roles %>%
  left_join(actors, by = c("actor_id" = "id")) %>%
  filter(gender == 'F') %>%  
  group_by(role) %>%
  summarise(num_actrices = n_distinct(actor_id))

directores_por_rol <- roles %>%
  left_join(movies_directors, by = "movie_id") %>% 
  group_by(role) %>%   
  summarise(num_directores = n_distinct(director_id))

reporte_por_rol <- peliculas_por_rol %>%
  left_join(actores_por_rol, by = "role") %>%
  left_join(actrices_por_rol, by = "role") %>%
  left_join(directores_por_rol, by = "role")

reporte_por_rol <- reporte_por_rol %>%
  mutate(
    num_actores = ifelse(is.na(num_actores), 0, num_actores),
    num_actrices = ifelse(is.na(num_actrices), 0, num_actrices),
    num_directores = ifelse(is.na(num_directores), 0, num_directores)
  )

print(reporte_por_rol)
```

```{r Reporte por Director}
peliculas_por_director <- movies_directors %>%
  group_by(director_id) %>%
  summarise(num_peliculas = n_distinct(movie_id))

actores_por_director <- movies_directors %>%
  left_join(roles, by = "movie_id") %>%
  group_by(director_id) %>%
  summarise(num_actores = n_distinct(actor_id))

genero_comun_por_director <- movies_directors %>%
  left_join(movies_genres, by = "movie_id") %>%
  group_by(director_id, genre) %>%
  summarise(num_peliculas_genero = n()) %>%
  slice_max(num_peliculas_genero, n = 1, with_ties = FALSE) %>%
  ungroup() %>%
  select(director_id, genre)

reporte_directores <- directors %>%
  left_join(peliculas_por_director, by = c("id" = "director_id")) %>%
  left_join(actores_por_director, by = c("id" = "director_id")) %>%
  left_join(genero_comun_por_director, by = c("id" = "director_id"))

reporte_directores <- reporte_directores %>%
  mutate(
    num_peliculas = ifelse(is.na(num_peliculas), 0, num_peliculas),
    num_actores = ifelse(is.na(num_actores), 0, num_actores),
    genre = ifelse(is.na(genre), "", genre)
  )

print(reporte_directores)

```

```{r 5. Distribución de Roles por Película y Director}
dist_roles_pelicula <- roles %>%
  group_by(movie_id) %>%
  summarise(n_roles = n_distinct(role)) %>%
  group_by(n_roles) %>%
  summarise(n_movies = n()) %>%
  arrange(n_roles)

dist_roles_director <- movies_directors %>%
  left_join(roles, by = "movie_id") %>%
  group_by(director_id) %>%
  summarise(n_roles = n_distinct(role)) %>%
  group_by(n_roles) %>%
  summarise(n_directors = n()) %>%
  arrange(n_roles)

dist_roles_combined <- full_join(dist_roles_pelicula, dist_roles_director, by = "n_roles") %>%
  arrange(n_roles)

dist_roles_combined <- dist_roles_combined %>%
  mutate(
    n_movies = ifelse(is.na(n_movies), 0, n_movies),
    n_directors = ifelse(is.na(n_directors), 0, n_directors)
  )

print(dist_roles_combined)
```
